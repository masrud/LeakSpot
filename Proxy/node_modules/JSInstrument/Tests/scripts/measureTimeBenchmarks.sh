DIR=$1

#echo "Remove old instrumented files"
#instrumentedFiles=`ls $DIR/*INS.js`
#for f in $instrumentedFiles
#do
#    rm $f -f
#done
#
#echo "instrument all the files"
#jsfiles=`ls $DIR/*.js`
#
#for f in $jsfiles
#do
#node instrumentFile.js $f
#done

cd $DIR
echo "running the old and new files and comparing results"
files=`ls *INS.js`
for f in    $files
do

    avgInstrumented=0

    for rep in {1..10}
    do
        ts=$(date +%s%N) 
        node $f > r2
        ttakenIns=$((($(date +%s%N) - $ts)/1000000)) 
        avgInstrumented=$(($avgInstrumented + $ttakenIns))
    done    

    if [ $? -eq 0 ]; then
        echo $f ------- OK
    else
        echo $f -------- FAIL
     fi  
     cp instrumentData instrumentData-$f-III
     originalF=${f/INS/}
    echo $originalF

    avgOriginal=0;
    for rep in {1..10}
    do
        ts=$(date +%s%N) 
         node $originalF > r1
        ttakenOrig=$((($(date +%s%N) - $ts)/1000000)) 
        avgOriginal=$(($avgOriginal + $ttakenOrig))
    done
    
    avgInstrumented=$((avgInstrumented / 10))
    avgOriginal=$((avgOriginal / 10))
    echo "TIME:   " $originalF  "  TimeOriginal: " $ttakenOrig   "  TimeInstrumented: " $ttakenIns
    echo "TIMEAVG: "$originalF  "  avgOriginal:   " $avgOriginal "  avgInstrumented:  "  $avgInstrumented


     diff r1 r2 > difffile 
     if [ $? -ne 0 ] 
     then
     echo $f "  " $originalF " ^^^^^^^^^^^^^different results "
     fi  
 done

#To generate data file for graph, write the output to a file (data) and then:
#cat data | grep TIME | awk '{print $2 "    " $4 "       " $6}' > d3

